---
layout: post
title: Avoiding Caching with Rails ActiveRecord
date: 2014-08-14 15:08:10.000000000 -05:00
categories:
- Rails
tags:
- activerecord
- postgres
- rails
status: publish
type: post
published: true
author: Adam N England
excerpt: <p>Today, I came across a puzzling issue with Rails 4.1, ActiveRecord, and Postgres when trying to select random records from a database table.</p><p>To demonstrate, let's use a simple social network API example. Clients will POST a list of user, and I'll "match" them to someone in my database.</p><p>Easy enough, for testing purposes we can just select a random user from our "users" table in postgres to simulate a match.</p>
---
<p>Today, I came across a puzzling issue with Rails 4.1, ActiveRecord, and Postgres when trying to select random records from a database table.</p>
<p>To demonstrate, let's use a simple social network API example. Clients will POST a list of user, and I'll "match" them to someone in my database.</p>
<p>Easy enough, for testing purposes we can just select a random user from our "users" table in postgres to simulate a match.</p>

{% highlight ruby linenos %}
contacts = [{:id => 1}, {:id => 2}, {:id => 3}, {:id => 4}]
contacts.each do |c|
  user = User.order('random()').first
  c[:detail] = {:username => user.username}
end
{% endhighlight %}

<p>Run that in our rails console, and good things happen.  Seems like we have some random users from my (small) database.<br />

{% highlight ruby linenos %}
[{:id=>1, :detail=>{:username=>"adam5"}},
 {:id=>2, :detail=>{:username=>"adam1"}},
 {:id=>3, :detail=>{:username=>"adam11"}},
 {:id=>4, :detail=>{:username=>"adam5"}}]
{% endhighlight %}

<p>Let's move that code into a controller action.

{% highlight ruby linenos %}
  def create
    contacts = [{:id => 1}, {:id => 2}, {:id => 3}, {:id => 4}]
    contacts.each do |c|
      user = User.order('random()').first
      c[:detail] = {:username => user.username}
    end
    render :json => contacts, :root => false
  end
{% endhighlight %}

<p>Uh-oh. This time, we get a decidedly un-random response:<br />

{% highlight javascript %}
[
    {
        "id": 1,
        "detail": {
            "username": "adam6"
        }
    },
    {
        "id": 2,
        "detail": {
            "username": "adam6"
        }
    },
    {
        "id": 3,
        "detail": {
            "username": "adam6"
        }
    },
    {
        "id": 4,
        "detail": {
            "username": "adam6"
        }
    }
]
{% endhighlight %}

<p>Looking at the logs, we'll see this:<br />

{% highlight bash %}
  User Load (0.7ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
  User Load (0.7ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
  CACHE (0.0ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
  CACHE (0.0ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
  CACHE (0.0ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
  CACHE (0.0ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
  CACHE (0.0ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
  CACHE (0.0ms)  SELECT  "users".* FROM "users"   ORDER BY random() LIMIT 1
{% endhighlight %}

<p>Rails caching, normally so useful, causes a problem in this situation.  No sweat.  You just need to use <a href="http://api.rubyonrails.org/classes/ActiveRecord/QueryCache/ClassMethods.html#method-i-uncached">ActiveRecord's uncached method.</a></p>
<p>Modifying the action to use uncached looks like this:<br />

{% highlight ruby linenos %}
  def create
    contacts = [{:id => 1}, {:id => 2}, {:id => 3}, {:id => 4}]
    contacts.each do |c|
      User.uncached do
        user = User.order('random()').first
        c[:detail] = {:username => user.username}
      end
    end
    render :json => contacts, :root => false
  end
{% endhighlight %}

<p>The database query no longer gets cached for the duration of the "User.uncached" block, and a new query is executed for each iteration. The controller action now gives us some nice, randomized output.<br />
{% highlight javascript %}
[
    {
        "id": 1,
        "detail": {
            "username": "adam3"
        }
    },
    {
        "id": 2,
        "detail": {
            "username": "adam3"
        }
    },
    {
        "id": 3,
        "detail": {
            "username": "adam4"
        }
    },
    {
        "id": 4,
        "detail": {
            "username": "adam1"
        }
    }
]
{% endhighlight %}
